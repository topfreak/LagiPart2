(()=>{"use strict";const e="BCCs2eonMI-6H2ctvFaWg-UYdDv387Vno_bzUzALpB442r2lCnsHmtrx8biyPi_E-1fSGABK_Qs_GlvPoJJqxbk",t="https://story-api.dicoding.dev/v1/",a={register:async({name:e,email:a,password:n})=>(await fetch(`${t}register`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({name:e,email:a,password:n})})).json(),login:async({email:e,password:a})=>(await fetch(`${t}login`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({email:e,password:a})})).json(),async addStory({token:e,description:a,photo:n,lat:i,lon:r}){const o=new FormData;return o.append("description",a),o.append("photo",n),i&&o.append("lat",i),r&&o.append("lon",r),(await fetch(`${t}stories`,{method:"POST",headers:{Authorization:`Bearer ${e}`},body:o})).json()},async addGuestStory({description:e,photo:a,lat:n,lon:i}){const r=new FormData;return r.append("description",e),r.append("photo",a),n&&r.append("lat",n),i&&r.append("lon",i),(await fetch(`${t}stories/guest`,{method:"POST",body:r})).json()},async getAllStories({token:e,page:a,size:n,location:i=0}){const r=new URLSearchParams;return a&&r.append("page",a),n&&r.append("size",n),void 0!==i&&r.append("location",i),(await fetch(`${t}stories?${r.toString()}`,{headers:{Authorization:`Bearer ${e}`}})).json()},getStoryDetail:async({token:e,id:a})=>(await fetch(`${t}stories/${a}`,{headers:{Authorization:`Bearer ${e}`}})).json(),subscribeNotification:async({token:e,endpoint:a,keys:n})=>(await fetch(`${t}notifications/subscribe`,{method:"POST",headers:{"Content-Type":"application/json",Authorization:`Bearer ${e}`},body:JSON.stringify({endpoint:a,keys:n})})).json(),unsubscribeNotification:async({token:e,endpoint:a})=>(await fetch(`${t}notifications/subscribe`,{method:"DELETE",headers:{"Content-Type":"application/json",Authorization:`Bearer ${e}`},body:JSON.stringify({endpoint:a})})).json()},n=(e,t)=>t.some((t=>e instanceof t));let i,r;const o=new WeakMap,s=new WeakMap,l=new WeakMap;let c={get(e,t,a){if(e instanceof IDBTransaction){if("done"===t)return o.get(e);if("store"===t)return a.objectStoreNames[1]?void 0:a.objectStore(a.objectStoreNames[0])}return p(e[t])},set:(e,t,a)=>(e[t]=a,!0),has:(e,t)=>e instanceof IDBTransaction&&("done"===t||"store"===t)||t in e};function d(e){c=e(c)}function h(e){return"function"==typeof e?(t=e,(r||(r=[IDBCursor.prototype.advance,IDBCursor.prototype.continue,IDBCursor.prototype.continuePrimaryKey])).includes(t)?function(...e){return t.apply(u(this),e),p(this.request)}:function(...e){return p(t.apply(u(this),e))}):(e instanceof IDBTransaction&&function(e){if(o.has(e))return;const t=new Promise(((t,a)=>{const n=()=>{e.removeEventListener("complete",i),e.removeEventListener("error",r),e.removeEventListener("abort",r)},i=()=>{t(),n()},r=()=>{a(e.error||new DOMException("AbortError","AbortError")),n()};e.addEventListener("complete",i),e.addEventListener("error",r),e.addEventListener("abort",r)}));o.set(e,t)}(e),n(e,i||(i=[IDBDatabase,IDBObjectStore,IDBIndex,IDBCursor,IDBTransaction]))?new Proxy(e,c):e);var t}function p(e){if(e instanceof IDBRequest)return function(e){const t=new Promise(((t,a)=>{const n=()=>{e.removeEventListener("success",i),e.removeEventListener("error",r)},i=()=>{t(p(e.result)),n()},r=()=>{a(e.error),n()};e.addEventListener("success",i),e.addEventListener("error",r)}));return l.set(t,e),t}(e);if(s.has(e))return s.get(e);const t=h(e);return t!==e&&(s.set(e,t),l.set(t,e)),t}const u=e=>l.get(e),m=["get","getKey","getAll","getAllKeys","count"],g=["put","add","delete","clear"],y=new Map;function w(e,t){if(!(e instanceof IDBDatabase)||t in e||"string"!=typeof t)return;if(y.get(t))return y.get(t);const a=t.replace(/FromIndex$/,""),n=t!==a,i=g.includes(a);if(!(a in(n?IDBIndex:IDBObjectStore).prototype)||!i&&!m.includes(a))return;const r=async function(e,...t){const r=this.transaction(e,i?"readwrite":"readonly");let o=r.store;return n&&(o=o.index(t.shift())),(await Promise.all([o[a](...t),i&&r.done]))[0]};return y.set(t,r),r}d((e=>({...e,get:(t,a,n)=>w(t,a)||e.get(t,a,n),has:(t,a)=>!!w(t,a)||e.has(t,a)})));const v=["continue","continuePrimaryKey","advance"],f={},b=new WeakMap,k=new WeakMap,S={get(e,t){if(!v.includes(t))return e[t];let a=f[t];return a||(a=f[t]=function(...e){b.set(this,k.get(this)[t](...e))}),a}};async function*E(...e){let t=this;if(t instanceof IDBCursor||(t=await t.openCursor(...e)),!t)return;const a=new Proxy(t,S);for(k.set(a,t),l.set(a,u(t));t;)yield a,t=await(b.get(a)||t.continue()),b.delete(a)}function I(e,t){return t===Symbol.asyncIterator&&n(e,[IDBIndex,IDBObjectStore,IDBCursor])||"iterate"===t&&n(e,[IDBIndex,IDBObjectStore])}d((e=>({...e,get:(t,a,n)=>I(t,a)?E:e.get(t,a,n),has:(t,a)=>I(t,a)||e.has(t,a)})));const B="stories",P=function(e,t,{blocked:a,upgrade:n,blocking:i,terminated:r}={}){const o=indexedDB.open(e,t),s=p(o);return n&&o.addEventListener("upgradeneeded",(e=>{n(p(o.result),e.oldVersion,e.newVersion,p(o.transaction),e)})),a&&o.addEventListener("blocked",(e=>a(e.oldVersion,e.newVersion,e))),s.then((e=>{r&&e.addEventListener("close",(()=>r())),i&&e.addEventListener("versionchange",(e=>i(e.oldVersion,e.newVersion,e)))})).catch((()=>{})),s}("story_share_db",1,{upgrade(e){e.objectStoreNames.contains(B)||e.createObjectStore(B,{keyPath:"id"})}}),D={async saveStory(e){const t=await P;console.log("Menyimpan story ke IndexedDB:",e),await t.put(B,e)},getAllStories:async()=>(await P).getAll(B),async deleteStory(e){const t=await P;await t.delete(B,e)}};class T{constructor(e){this.view=e,this.searchQuery=""}async initialize(){await this.loadAllStories(),this.initializePushNotifications()}async loadAllStories(){try{this.view.showLoading();const e=localStorage.getItem("token");if(!e)return this.view.showAuthWarning();const t=await a.getAllStories({token:e,location:this.view.showLocationStories?1:0,search:this.searchQuery});console.log("API Response:",t),this.handleResponse(t);const n=t?.data?.stories||t?.listStory||t?.stories||[];Array.isArray(n)&&n.forEach((e=>D.saveStory(e)))}catch(e){console.warn("Gagal memuat data dari API, mencoba memuat dari IndexedDB...",e);const t=await D.getAllStories();console.log("Data dari IndexedDB:",t),t.length>0?this.view.displayStories(t):this.view.showError("Tidak ada data yang tersedia untuk ditampilkan.")}finally{this.view.hideLoading()}}handleResponse(e){const t=[...e?.data?.stories||[],...e?.listStory||[],...e?.stories||[]];if(!Array.isArray(t))throw new Error("Format data story tidak valid");this.view.displayStories(t)}async deleteStory(e){try{await D.deleteStory(e);const t=await D.getAllStories();this.view.displayStories(t)}catch(e){console.error("Gagal menghapus story:",e)}}async initializePushNotifications(){if("serviceWorker"in navigator&&"PushManager"in window)try{const t=await navigator.serviceWorker.register("/sw.js");if("granted"===await Notification.requestPermission()){const a=await t.pushManager.subscribe({userVisibleOnly:!0,applicationServerKey:this._urlBase64ToUint8Array(e)});await this.handleSubscription(a)}else console.warn("Push notification permission denied.")}catch(e){console.error("Push notification initialization failed:",e)}}async handleSubscription(e){try{await a.subscribeNotification({token:localStorage.getItem("token"),endpoint:e.endpoint,keys:{p256dh:e.keys.p256dh,auth:e.keys.auth}})}catch(e){console.error("Subscription error:",e)}}_urlBase64ToUint8Array(e){const t=(e+"=".repeat((4-e.length%4)%4)).replace(/-/g,"+").replace(/_/g,"/"),a=window.atob(t),n=new Uint8Array(a.length);for(let e=0;e<a.length;++e)n[e]=a.charCodeAt(e);return n}}class C{constructor(e){this.view=e}async handleLoginForm(e,t){try{this.validateInput(e,t);const n=await a.login({email:e,password:t});if(!n.error)return this.handleSuccess(n),!0;throw new Error(n.message)}catch(e){return this.view.showError(`Gagal login: ${e.message}`),!1}}validateInput(e,t){const a=[];if(e||a.push("email"),t||a.push("password"),a.length>0)throw new Error(`Harap isi ${a.join(" dan ")}!`)}handleSuccess(e){localStorage.setItem("token",e.loginResult.token),localStorage.setItem("user",JSON.stringify({name:e.loginResult.name,email:e.loginResult.email})),this.view.app&&"function"==typeof this.view.app.updateNavigation&&this.view.app.updateNavigation(),this.view.showSuccess(`Selamat datang ${e.loginResult.name}!`,"#/")}}class M{constructor(e){this.view=e}async handleRegistration(e,t,n){try{this.validateInput(e,t,n);const i=await a.register({name:e,email:t,password:n});if(i.error)throw new Error(i.message);const r=await a.login({email:t,password:n});if(r.error)throw new Error(r.message);return this.handleSuccess(r),!0}catch(e){return this.view.showError(`Gagal registrasi: ${e.message}`),!1}}validateInput(e,t,a){const n=[];if(e||n.push("nama"),t||n.push("email"),a||n.push("password"),n.length>0)throw new Error(`Harap isi ${n.join(", ")}!`);if(a.length<6)throw new Error("Password minimal 6 karakter!")}handleSuccess(e){localStorage.setItem("token",e.loginResult.token),localStorage.setItem("user",JSON.stringify({name:e.loginResult.name,email:e.loginResult.email})),this.view.app&&"function"==typeof this.view.app.updateNavigation&&this.view.app.updateNavigation(),this.view.showSuccess("Registrasi berhasil! Anda sudah login","#/")}}class A{constructor(e){this.view=e,this.selectedLocation=null}handleMapClick(e){this.selectedLocation=e}async handleFormSubmit(e,t){try{this.validateInput(e,t);const n=await a.addStory({token:localStorage.getItem("token"),description:e,photo:t,lat:this.selectedLocation?.lat,lon:this.selectedLocation?.lng});if(n.error)throw new Error(n.message);this.view.showSuccess()}catch(e){this.view.showError(e.message)}}validateInput(e,t){const a=[];if(e||a.push("deskripsi"),t||a.push("foto"),this.selectedLocation||a.push("lokasi peta"),a.length>0)throw new Error(`Harap isi ${a.join(", ")}!`)}}const $={"/":new class{constructor(){this.presenter=new T(this),this.showLocationStories=!0,this.onHashChange=this.handleHashChange.bind(this)}async render(){return'\n    <section class="container">\n      <div class="home-header">\n        <h1><i data-feather="book-open"></i> Daftar Story</h1>\n      </div>\n\n      <div id="loading" class="loading">\n        Memuat...\n      </div>\n\n      <div id="story-list" class="story-list"></div>\n    </section>\n  '}async afterRender(){feather.replace(),await this.presenter.initialize(),this.createFAB()}createFAB(){if(document.querySelector(".fab"))return;const e=document.createElement("button");e.className="fab",e.innerHTML='<i data-feather="plus"></i> Buat Cerita',e.addEventListener("click",(()=>window.location.hash="#/add-story")),document.body.appendChild(e),window.addEventListener("hashchange",this.onHashChange)}handleHashChange(){window.location.hash.startsWith("#/home")||this.destroyFAB()}destroyFAB(){const e=document.querySelector(".fab");e?.remove(),window.removeEventListener("hashchange",this.onHashChange)}showLoading(){const e=document.getElementById("loading");e&&(e.style.display="block");const t=document.getElementById("story-list");t&&(t.innerHTML="")}hideLoading(){const e=document.getElementById("loading");e&&(e.style.display="none")}showAuthWarning(){document.getElementById("story-list").innerHTML='\n      <div class="auth-warning">\n        <i data-feather="lock"></i> Silakan <a href="#/login">login</a> untuk melihat story\n      </div>'}displayStories(e){const t=document.querySelector("#story-list");t.innerHTML="",0!==e.length?e.forEach((e=>{const a=this.createStoryElement(e);t.appendChild(a)})):t.innerHTML="<p>Tidak ada cerita yang tersedia.</p>"}showError(e){document.querySelector("#main-content").innerHTML=`\n      <div class="error-state">\n        <i data-feather="alert-circle"></i> ${e||"Gagal memuat story"}\n      </div>`}createStoryElement(e){const t=document.createElement("div");t.className="story-item",t.innerHTML=this.getStoryHTML(e),e.lat&&e.lon&&this.initMap(t,e);const a=document.createElement("button");return a.className="delete-button",a.textContent="Hapus",a.addEventListener("click",(()=>{this.presenter.deleteStory(e.id)})),t.appendChild(a),t}getStoryHTML(e){const t=this.sanitizeId(e.createdAt);return`\n      <div class="story-header">\n        <h3 class="story-title">${e.name}</h3>\n        <div class="story-date">\n          <i data-feather="calendar"></i>\n          ${new Date(e.createdAt).toLocaleDateString("id-ID",{day:"numeric",month:"long",year:"numeric",hour:"2-digit",minute:"2-digit"})}\n        </div>\n      </div>\n      <p class="story-description">${e.description}</p>\n      <img src="${e.photoUrl}" alt="Gambar story ${e.name}" class="story-image" loading="lazy">\n      ${e.lat&&e.lon?`\n        <div class="story-map-container">\n          <div class="story-map" id="map-${t}"></div>\n          <div class="location-info">\n            <i data-feather="map-pin"></i>\n            Lokasi: ${e.lat.toFixed(4)}, ${e.lon.toFixed(4)}\n          </div>\n        </div>\n      `:""}\n    `}sanitizeId(e){return e.replace(/[^a-zA-Z0-9]/g,"-").replace(/-+/g,"-").replace(/^-|-$/g,"")}initMap(e,t){const a=this.sanitizeId(t.createdAt),n=e.querySelector(`#map-${a}`);if(!n)return;n.style.height="250px",n.style.width="100%";const i=L.map(n,{center:[t.lat,t.lon],zoom:13,zoomControl:!1,scrollWheelZoom:!1});n.style.zIndex="0";const r=L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png",{attribution:'¬© <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a>'}),o=L.tileLayer("https://api.maptiler.com/maps/hybrid/{z}/{x}/{y}.jpg?key=phKlUR2uQ7LzZPu21Y47",{attribution:'<a href="https://www.maptiler.com/copyright/">MapTiler</a>'}),s=L.tileLayer("https://api.maptiler.com/maps/streets/{z}/{x}/{y}.png?key=phKlUR2uQ7LzZPu21Y47",{attribution:'<a href="https://www.maptiler.com/copyright/">MapTiler</a>'});r.addTo(i);const l={OpenStreetMap:r,Satellite:o,"MapTiler Streets":s};L.control.layers(l,null,{position:"bottomright",collapsed:!1}).addTo(i);const c=L.icon({iconUrl:"https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.7.1/images/marker-icon.png",iconSize:[25,41],iconAnchor:[12,41]});L.marker([t.lat,t.lon],{icon:c}).bindPopup(`<div class="map-popup"><h4>${t.name}</h4></div>`).addTo(i),setTimeout((()=>i.invalidateSize()),10)}destroy(){this.destroyFAB()}},"/about":new class{async render(){return'\n      <section class="container">\n        <h1><i data-feather="user"></i> Tentang Pembuat</h1>\n        \n        <div class="bio-container">\n          <div class="bio-item">\n            <i data-feather="user"></i>\n            <span class="bio-label">Nama :</span>\n            <span class="bio-value">Taufiq Hidayatullah</span>\n          </div>\n\n          <div class="bio-item">\n            <i data-feather="book"></i>\n            <span class="bio-label">Asal Universitas :</span>\n            <span class="bio-value">Universitas Amikom Yogyakarta</span>\n          </div>\n\n          <div class="bio-item">\n            <i data-feather="award"></i>\n            <span class="bio-label">Program Studi :</span>\n            <span class="bio-value">S1-Informatika</span>\n          </div>\n\n          <div class="bio-item">\n            <i data-feather="heart"></i>\n            <span class="bio-label">Minat :</span>\n            <span class="bio-value">Web Development, Data Mining</span>\n          </div>\n        </div>\n      </section>\n    '}async afterRender(){feather.replace()}},"/login":new class{constructor(){this.presenter=new C(this),this.app=document.querySelector("main")?.app}async render(){return'\n      <section class="container auth-container">\n        <h1><i data-feather="lock"></i> Login</h1>\n        <form id="loginForm" class="auth-form">\n          <div class="form-group">\n            <label for="email"><i data-feather="mail"></i> Email</label>\n            <input \n              type="email" \n              id="email" \n              name="email" \n              required\n              placeholder="email@contoh.com"\n            >\n          </div>\n          <div class="form-group">\n            <label for="password"><i data-feather="key"></i> Password</label>\n            <input \n              type="password" \n              id="password" \n              name="password" \n              required\n              placeholder="Password"\n            >\n          </div>\n          <button type="submit" class="submit-button">\n            <i data-feather="log-in"></i> Masuk\n          </button>\n        </form>\n        <p class="auth-link">\n          Belum punya akun? <a href="#/register"><i data-feather="user-plus"></i> Daftar di sini</a>\n        </p>\n      </section>\n    '}async afterRender(){feather.replace();const e=document.getElementById("loginForm");e?e.addEventListener("submit",(async t=>{t.preventDefault();const a=e.email.value.trim(),n=e.password.value.trim();await this.presenter.handleLoginForm(a,n)})):console.error("Login form tidak ditemukan!")}showError(e){alert(`‚ùå ${e}`)}showSuccess(e,t){alert(`üéâ ${e}`),t&&(window.location.hash=t)}},"/register":new class{constructor(){this.presenter=new M(this),this.app=document.querySelector("main")?.app}async render(){return'\n      <section class="container auth-container">\n        <h1><i data-feather="user-plus"></i> Registrasi</h1>\n        <form id="registerForm" class="auth-form">\n          <div class="form-group">\n            <label for="name"><i data-feather="user"></i> Nama</label>\n            <input \n              type="text" \n              id="name" \n              name="name" \n              required\n              placeholder="Nama lengkap"\n            >\n          </div>\n          <div class="form-group">\n            <label for="email"><i data-feather="mail"></i> Email</label>\n            <input \n              type="email" \n              id="email" \n              name="email" \n              required\n              placeholder="email@contoh.com"\n            >\n          </div>\n          <div class="form-group">\n            <label for="password"><i data-feather="key"></i> Password</label>\n            <input \n              type="password" \n              id="password" \n              name="password" \n              required\n              placeholder="Minimal 6 karakter"\n            >\n          </div>\n          <button type="submit" class="submit-button">\n            <i data-feather="edit"></i> Daftar\n          </button>\n        </form>\n        <p class="auth-link">\n          Sudah punya akun? <a href="#/login"><i data-feather="log-in"></i> Login di sini</a>\n        </p>\n      </section>\n    '}async afterRender(){feather.replace();const e=document.getElementById("registerForm");e?e.addEventListener("submit",(async t=>{t.preventDefault();const a=e.name.value.trim(),n=e.email.value.trim(),i=e.password.value.trim();await this.presenter.handleRegistration(a,n,i)})):console.error("Register form tidak ditemukan!")}showError(e){alert(`‚ùå ${e}`)}showSuccess(e,t){alert(`üéâ ${e}`),t&&(window.location.hash=t)}},"/add-story":new class{constructor(){this.presenter=new A(this),this.map=null,this.marker=null,this.mediaStream=null,this.capturedPhoto=null,this.cameraElements={openButton:null,captureButton:null,previewPlaceholder:null}}async render(){return'\n      <section class="container add-story-container">\n        <h1><i data-feather="edit-3"></i> Buat Cerita Baru</h1>\n        <form id="storyForm" class="story-form">\n          <div class="form-group">\n            <label for="description"><i data-feather="align-left"></i> Deskripsi Cerita</label>\n            <textarea \n              id="description" \n              name="description" \n              required\n              rows="4"\n              placeholder="Ceritakan momen spesialmu..."\n            ></textarea>\n          </div>\n\n          <div class="media-container">\n            <div class="camera-preview" id="cameraPreview">\n              <p class="preview-placeholder"><i data-feather="video"></i> Kamera belum diaktifkan</p>\n            </div>\n            \n            <div class="media-buttons">\n              <button type="button" id="openCamera" class="camera-button">\n                <i data-feather="camera"></i> Buka Kamera\n              </button>\n              \n              <button type="button" id="captureButton" class="capture-button" style="display: none;">\n                <i data-feather="aperture"></i> Ambil Foto\n              </button>\n              \n              <input type="file" id="photo" name="photo" accept="image/*" hidden />\n              <label for="photo" class="upload-button">\n                <i data-feather="upload"></i> Unggah Foto\n              </label>\n            </div>\n          </div>\n\n          <div class="form-group">\n            <label><i data-feather="map"></i> Pilih Lokasi</label>\n            <div id="map" class="story-map"></div>\n            <div class="coordinates">\n              <span><i data-feather="map-pin"></i> Latitude: <span id="latValue">-</span></span>\n              <span><i data-feather="map-pin"></i> Longitude: <span id="lonValue">-</span></span>\n            </div>\n          </div>\n\n          <button type="submit" class="submit-button">\n            <i data-feather="send"></i> Publikasikan Cerita\n          </button>\n        </form>\n      </section>\n    '}async afterRender(){feather.replace(),this.initMap(),this.setupEventListeners()}initMap(){this.map=L.map("map",{center:[-2.5489,118.0149],zoom:5,zoomControl:!1,preferCanvas:!0});const e=document.getElementById("map");e&&(e.style.zIndex="0");const t=L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png",{attribution:'¬© <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a>'}),a=L.tileLayer("https://api.maptiler.com/maps/hybrid/{z}/{x}/{y}.jpg?key=phKlUR2uQ7LzZPu21Y47",{attribution:'<a href="https://www.maptiler.com/copyright/">MapTiler</a>'}),n=L.tileLayer("https://api.maptiler.com/maps/streets/{z}/{x}/{y}.png?key=phKlUR2uQ7LzZPu21Y47",{attribution:'<a href="https://www.maptiler.com/copyright/">MapTiler</a>'});t.addTo(this.map);const i={OpenStreetMap:t,Satellite:a,"MapTiler Streets":n};L.control.layers(i,null,{position:"bottomright",collapsed:!1}).addTo(this.map),this.map.on("click",(e=>{this.presenter.handleMapClick(e.latlng),this.updateMapMarker(e.latlng)}))}updateMapMarker(e){this.marker&&this.marker.remove(),this.marker=L.marker(e,{draggable:!1}).addTo(this.map).bindPopup("üìç Lokasi Dipilih"),document.getElementById("latValue").textContent=e.lat.toFixed(5),document.getElementById("lonValue").textContent=e.lng.toFixed(5)}setupEventListeners(){document.getElementById("cameraPreview");const e=document.getElementById("openCamera"),t=document.getElementById("captureButton"),a=document.getElementById("photo");e.addEventListener("click",(()=>this.startCamera())),t.addEventListener("click",(()=>this.capturePhoto())),a.addEventListener("change",(e=>this.handleFileUpload(e))),document.getElementById("storyForm").addEventListener("submit",(e=>{e.preventDefault(),this.presenter.handleFormSubmit(e.target.description.value.trim(),this.capturedPhoto||a.files[0])}))}async startCamera(){try{this.stopCamera();const e=document.getElementById("cameraPreview");if(!e)return void this.showError("Elemen kamera tidak ditemukan");this.mediaStream=await navigator.mediaDevices.getUserMedia({video:{facingMode:"environment",width:{ideal:1280},height:{ideal:720}},audio:!1}),this.toggleCameraUI(!0),e.innerHTML='<video class="live-camera" autoplay playsinline></video>';const t=e.querySelector("video");t&&this.mediaStream&&(t.srcObject=this.mediaStream,t.onloadedmetadata=()=>{t.play().catch((e=>{this.handleCameraError(e)}))})}catch(e){this.handleCameraError(e)}}handleCameraError(e){let t="Gagal mengakses kamera!";"NotAllowedError"===e.name?t+="\n\nüîí Tolong berikan izin akses kamera di pengaturan browser!":"NotFoundError"===e.name?t+="\n\nüì∑ Tidak ditemukan perangkat kamera!":t+=`\n\nKode error: ${e.name}`,this.toggleCameraUI(!1),this.showError(t)}toggleCameraUI(e){const t=document.getElementById("openCamera"),a=document.getElementById("captureButton"),n=document.querySelector(".preview-placeholder");t&&a&&n?(t.style.display=e?"none":"flex",a.style.display=e?"flex":"none",n.style.display=e?"none":"block",t.offsetHeight):console.error("Elemen UI kamera tidak ditemukan!")}capturePhoto(){try{const e=document.querySelector(".live-camera");if(!e||4!==e.readyState)return void this.showError("Video belum siap direkam");const t=document.createElement("canvas");t.width=e.videoWidth,t.height=e.videoHeight,t.getContext("2d").drawImage(e,0,0,t.width,t.height),t.toBlob((e=>{if(e)try{this.capturedPhoto=new File([e],"story.jpg",{type:"image/jpeg",lastModified:Date.now()}),this.showPhotoPreview(URL.createObjectURL(e)),this.stopCamera(),this.toggleCameraUI(!1)}catch(e){this.handleCameraError(e)}else this.showError("Gagal mengambil foto")}),"image/jpeg",.85)}catch(e){this.handleCameraError(e)}}showPhotoPreview(e){const t=document.getElementById("cameraPreview");t&&(t.innerHTML=`\n    <img src="${e}" class="captured-image">\n    <button class="retake-button">‚ü≥ Ambil Ulang</button>\n  `,t.querySelector(".retake-button").addEventListener("click",(()=>{t.innerHTML='<p class="preview-placeholder">üé• Kamera belum diaktifkan</p>',this.capturedPhoto=null,this.toggleCameraUI(!1)})))}stopCamera(){try{this.mediaStream&&(this.mediaStream.getTracks().forEach((e=>{"live"===e.readyState&&(e.stop(),e.enabled=!1)})),this.mediaStream=null);const e=document.querySelector(".live-camera");e&&(e.srcObject=null,e.remove())}catch(e){console.error("Error stopping camera:",e)}}async handleFileUpload(e){try{this.stopCamera();const t=e.target.files[0];if(!t)return;if(!t.type.startsWith("image/"))throw new Error("File harus berupa gambar");this.capturedPhoto=t,document.getElementById("cameraPreview")&&this.showPhotoPreview(URL.createObjectURL(t))}catch(t){this.showError(t.message),e.target.value=""}}showError(e){alert(`‚ùå Error: ${e}`)}showSuccess(){alert("üéâ Cerita berhasil dipublikasikan!"),window.location.hash="#/"}destroy(){this.stopCamera(),this.map&&(this.map.remove(),this.map=null)}},"/logout":new class{async render(){return'<div class="logout-processing">Memproses logout...</div>'}async afterRender(){localStorage.removeItem("token"),localStorage.removeItem("user"),setTimeout((()=>{window.location.hash="#/login"}),1e3)}},"*":new class{async render(){return'\n      <section class="container not-found-container">\n        <h1><i data-feather="alert-triangle"></i> Halaman Tidak Ditemukan</h1>\n        <p>Maaf, halaman yang Anda cari tidak tersedia.</p>\n        <a href="#/" class="back-home-button">\n          <i data-feather="home"></i> Kembali ke Beranda\n        </a>\n      </section>\n    '}async afterRender(){feather.replace()}}};const z=class{#e=null;#t=null;#a=null;constructor({navigationDrawer:e,drawerButton:t,content:a}){this.#e=a,this.#t=t,this.#a=e,this._setupDrawer(),this._setupViewTransitions()}_setupViewTransitions(){document.startViewTransition||(this.#e.style.animation="page-transition 0.3s ease")}updateNavigation(){const e=document.querySelector(".auth-item"),t=JSON.parse(localStorage.getItem("user"));t?(e.innerHTML=`\n        <a href="#/logout" class="logout-button">\n          <i data-feather="log-out"></i> Logout | <i data-feather="user"></i> ${t.name}\n        </a>\n      `,e.querySelector("a").addEventListener("click",(e=>{e.preventDefault(),localStorage.clear(),this.updateNavigation(),window.location.hash="#/login"}))):e.innerHTML='\n        <a href="#/login">\n          <i data-feather="log-in"></i> Login/Register\n        </a>\n      ',feather.replace()}_setupDrawer(){this.#t.addEventListener("click",(()=>{this.#a.classList.toggle("open")})),document.body.addEventListener("click",(e=>{const t=this.#a.contains(e.target),a=this.#t.contains(e.target);t||a||this.#a.classList.remove("open"),this.#a.querySelectorAll("a").forEach((t=>{t.contains(e.target)&&this.#a.classList.remove("open")}))}))}async renderPage(){const e=function(e){let t="";return e.resource&&(t=t.concat(`/${e.resource}`)),e.id&&(t=t.concat("/:id")),t||"/"}(function(e){const t=e.split("/");return{resource:t[1]||null,id:t[2]||null}}(location.hash.replace("#","")||"/")),t=$[e]||$["*"],a=this.#e.cloneNode(!0),n=document.startViewTransition?document.startViewTransition((()=>this._performPageUpdate(t))):{ready:Promise.resolve()};try{await n.ready;const e=a.animate([{transform:"translateX(0)",opacity:1},{transform:"translateX(-100%)",opacity:0}],{duration:500,easing:"cubic-bezier(0.4, 0, 0.2, 1)"}),t=this.#e.animate([{transform:"translateX(100%)",opacity:0},{transform:"translateX(0)",opacity:1}],{duration:500,easing:"cubic-bezier(0.4, 0, 0.2, 1)"});await Promise.all([e.finished,t.finished,this._handlePageTransition()])}catch(e){console.error("Error during transition:",e),await this._performPageUpdate(t)}}async _performPageUpdate(e){try{this.#e.innerHTML=await e.render(),await e.afterRender(),this.updateNavigation()}catch(e){console.error("Error rendering page:",e),this.#e.innerHTML='<div class="error">Error loading page</div>'}}async _handlePageTransition(){document.startViewTransition&&await document.documentElement.animate([{transform:"translateY(20px)",opacity:0},{transform:"translateY(0)",opacity:1}],{duration:300,easing:"ease-in-out"}).finished,document.querySelectorAll(".story-item, .auth-container").forEach((e=>{e.animate([{transform:"translateY(10px)",opacity:0},{transform:"translateY(0)",opacity:1}],{duration:600,easing:"cubic-bezier(0.4, 0, 0.2, 1)",delay:200})}))}};document.addEventListener("DOMContentLoaded",(async()=>{document.startViewTransition||(document.documentElement.style.animation="none"),"serviceWorker"in navigator&&window.addEventListener("load",(()=>{navigator.serviceWorker.register("/sw.js").then((e=>{console.log("Service Worker registered with scope:",e.scope)})).catch((e=>{console.error("Service Worker registration failed:",e)}))}));const e=new z({content:document.querySelector("#main-content"),drawerButton:document.querySelector("#drawer-button"),navigationDrawer:document.querySelector("#navigation-drawer")});await e.renderPage(),window.addEventListener("hashchange",(async()=>{await e.renderPage()}))}))})();